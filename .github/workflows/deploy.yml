- name: Run docker-compose on server
  uses: appleboy/ssh-action@v1.2.2
  with:
    host: ${{ secrets.SSH_HOST }}
    username: ${{ secrets.SSH_USER }}
    key: ${{ secrets.SSH_KEY }}
    port: ${{ secrets.SSH_PORT || 22 }}
    script: |
      set -e
      cd /opt/mail
      # Проверяем наличие .env файлов
      if [ ! -f .env.frontend ]; then
        echo "Error: .env.frontend not found"
        exit 1
      fi
      if [ ! -f .env.backend ]; then
        echo "Error: .env.backend not found"
        exit 1
      fi
      # Загружаем переменные
      export $(grep -Ev '^\s*(#|$)' .env.backend  | xargs)
      export $(grep -Ev '^\s*(#|$)' .env.frontend | xargs)
      docker-compose down --remove-orphans
      docker-compose up -d --build --no-cache
      docker image prune -f